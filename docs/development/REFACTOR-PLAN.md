# Nix Flake Refactoring and Declarative Language Enhancement Plan

This document outlines the plan to refactor the project's Nix configuration and to enhance the declarative language for a more streamlined and powerful user experience.

### 1. Core Objectives

1.  **Modular Flake Architecture**: Refactor the monolithic `flake.nix` into three distinct, composable flakes (`cli`, `compile`, and a root `devShell` flake) to improve maintainability and scalability.
2.  **Simplified Declarative Syntax**: Unify and simplify the artifact types and LaTeX commands to create a more elegant and intuitive authoring experience.
3.  **Compiler-Driven Metadata Injection**: Enhance the `cstex-compile` tool to automatically resolve artifact metadata from the `composable.toml` file, making it the single source of truth and reducing boilerplate in LaTeX documents.

### 2. Unified Artifact Model

The artifact types will be consolidated into two primary categories:

-   **`value`**: Represents any single, named value to be injected into the document (e.g., a correlation, a mean, a p-value). This replaces the previous `CSF-STAT` and `CSF-COMPUTE` types.
-   **`artifact`**: Represents any file-based output generated by the pipeline (e.g., figures, data tables, CSV files). This consolidates `CSF-ARTIFACT` and `CSF-TABLE`.

### 3. Simplified LaTeX Commands

The LaTeX commands will be simplified and unified:

-   `\csfvaluelink{name}{format}`: The new, single command for linking any named value defined in `composable.toml`.
-   `\csflink{path}`: The new command for linking any file-based artifact.

### 4. Compiler-Driven Metadata Workflow

The new workflow will be as follows:

1.  **Define in `composable.toml`**: The author formally declares computational outputs (both values and artifacts) in `composable.toml`.
2.  **Link in LaTeX**: The author uses the simple `\csfvaluelink` or `\csflink` commands in their `.tex` document, referencing the artifact by its name.
3.  **Compile with `cstex-compile`**: The compiler parses the `.tex` file, sees the link, and looks up the artifact's name in `composable.toml`.
4.  **Inject Provenance**: The compiler automatically injects the full provenance metadata (script, line number, dependencies, etc.) as a comment into an enhanced, intermediate `.tex` file before final compilation.

The verbose `% CSF-...` comments are now reserved for edge cases or one-off artifacts not formally declared in the pipeline.

### 5. Phased Implementation Plan

1.  **Update Core Logic**: Modify `compile/scripts/process-metadata.py` and `extract-values.py` to implement the new compiler-driven metadata injection and unified artifact model.
2.  **Update `composable.sty`**: Update the LaTeX package to use the new, simplified `\csfvaluelink` and `\csflink` commands.
3.  **Complete Flake Refactoring**: Resume and complete the file restructuring as originally planned (creating `cli/` and `compile/` flakes, moving scripts, and updating the root `flake.nix`).
4.  **Update All Documentation**: Update all `.md` files to reflect the new, streamlined syntax and architecture.

### Visual Architecture (Unchanged)

```mermaid
graph TD
    subgraph Root Project
        RootFlake["flake.nix (Primary Dev Env)"]
    end

    subgraph CLI Module
        CliFlake["cli/flake.nix"] -- Defines --> CliPackages["cs, dashboard, attest"]
    end

    subgraph Compile Module
        CompileFlake["compile/flake.nix"] -- Defines --> CompilePackages["cstex-compile, etc."]
    end

    RootFlake -- Imports --> CliFlake
    RootFlake -- Imports --> CompileFlake

    RootFlake -- Provides --> DevShell["devShells.default"]
    RootFlake -- Exposes --> AllPackages["All Packages (cs, cstex-compile, ...)"]