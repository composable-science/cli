# CSF Declarative Annotation System - Quick Start Guide

## ğŸš€ Getting Started

### Prerequisites
- Nix package manager installed
- Git repository clone of composci

### ğŸ“ Project Structure
```
composci/
â”œâ”€â”€ cli/flake.nix                     # Flake for the 'cs' CLI
â”œâ”€â”€ compile/
â”‚   â”œâ”€â”€ flake.nix                   # Flake for the cstex-compiler
â”‚   â””â”€â”€ scripts/                    # Compiler helper scripts
â”œâ”€â”€ core/templates/composable.sty     # Enhanced LaTeX package
â””â”€â”€ core/test/paper/                  # Test documents
```

## âš¡ Quick Test - 5 Minutes

### 1. Basic Functionality Test
```bash
cd composci/core/test/paper

# Create a simple test document
cat > my_test.tex << 'EOF'
\documentclass{article}
\usepackage{../../templates/composable}

\title{My CSF Test}
\author{Me}

\begin{document}
\maketitle

% CSF-STAT: name=my_correlation, type=correlation
Test: \csfvaluelink{my_correlation}{float,round2}

Mean: \csfvaluelink{my_mean}{float,round1}

This works in plain LaTeX!
\end{document}
EOF

# Compile with texMini (shows fallback behavior)
nix run github:alexmill/texMini -- my_test.tex

# Check result
ls -la my_test.pdf  # Should exist and show format specifiers
```

### 2. Verify CSF Annotations
```bash
# Check annotations are parsed correctly
grep "% CSF-" core/test/paper/paper_declarative_demo.tex

# Should show:
# - CSF-STAT annotations
# - CSF-COMPUTE annotations  
# - CSF-ARTIFACT annotations
# - CSF-TABLE annotations
```

### 3. Test Enhanced Package
```bash
# Verify composable.sty has required features
grep -A3 "providecommand.*csfstatlink" core/templates/composable.sty
grep "csf@getvalue" core/templates/composable.sty
grep "csfdefinevalue" core/templates/composable.sty
```

## ğŸ“– Usage Examples

### Example 1: Clean Statistical Results
```latex
\documentclass{article}
\usepackage{path/to/composable}

\begin{document}
% CSF-STAT: name=correlation_temp_pressure, type=correlation
The analysis shows r = \csfvaluelink{correlation_temp_pressure}{float,round2}.

Accuracy: \csfvaluelink{model_accuracy}{percent,round1}
\end{document}
```

**What you write:** Minimal semantic annotations
**What CSTeX discovers:** Script paths, line numbers, pipeline steps, dependencies
**Plain LaTeX Output:** Shows format specifiers (`float,round2`, `percent,round1`)
**CSTeX Output:** Shows actual computed values with full provenance links

### Example 2: Figure with Automatic Metadata
```latex
% CSF-ARTIFACT: type=figure, path=figures/analysis.png
\begin{figure}
\includegraphics{figures/analysis.png}
\caption{Analysis results}
\end{figure}
```

**What you write:** Just type and path
**What CSTeX discovers:** Generated by scripts/plot.py at line 67, from visualization step

### Example 3: Data Tables with Auto-Discovery
```latex
% CSF-TABLE: path=data/results.csv
\begin{table}
\input{data/results.csv}
\csftablelink{data/results.csv}{auto}
\caption{Processed experimental data}
\end{table}
```

**What you write:** Just the data path
**What CSTeX discovers:** Created by scripts/process.py, from processing step, complete lineage

## ğŸ”§ Advanced Workflow

### Full CSTeX Compilation (Future)
```bash
# When ready for full CSTeX features:
cd core/test/paper

# Compile with the new, unified cstex-compile command
# This now handles value extraction and metadata processing automatically.
nix run .#cstex-compile -- paper_declarative_demo.tex
```

### Value Injection System
When CSTeX processes documents:

1. **Parse Annotations** - Extract CSF comments
2. **Execute Pipeline** - Run computational scripts  
3. **Extract Values** - Get statistical outputs
4. **Generate .csf/values.tex** - Cache values for LaTeX
5. **Enhance Document** - Inject values and links
6. **Compile** - Generate final PDF with live data

## ğŸ§ª Testing & Validation

### Run All Tests
```bash
# From composci root
chmod +x scripts/test-with-nix.sh
./scripts/test-with-nix.sh
```

### Manual Verification
```bash
cd core/test/paper

# Test 1: Verify annotations exist
echo "=== CSF Annotations in Demo ==="
grep -c "% CSF-STAT:" paper_declarative_demo.tex
grep -c "% CSF-ARTIFACT:" paper_declarative_demo.tex  
grep -c "% CSF-COMPUTE:" paper_declarative_demo.tex
grep -c "% CSF-TABLE:" paper_declarative_demo.tex

# Test 2: Verify package features
echo "=== Package Features ==="
grep -q "providecommand.*csfstatlink" ../../templates/composable.sty && echo "âœ… Fallback commands"
grep -q "csf@getvalue" ../../templates/composable.sty && echo "âœ… Value injection"
grep -q "csfdefinevalue" ../../templates/composable.sty && echo "âœ… Value definition"

# Test 3: Verify compilation
echo "=== Compilation Test ==="
nix run github:alexmill/texMini -- test_simple_declarative.tex
ls test_simple_declarative.pdf && echo "âœ… PDF generated successfully"
```

## ğŸ“‹ Format Specifiers Reference

| Specifier | Output Example | Description |
|-----------|----------------|-------------|
| `float,round1` | `23.7` | 1 decimal place |
| `float,round2` | `0.85` | 2 decimal places |
| `float,round3` | `1.234` | 3 decimal places |
| `percent,round1` | `94.3%` | Percentage, 1 decimal |
| `percent,round2` | `94.32%` | Percentage, 2 decimals |
| `scientific,round3` | `1.234e-03` | Scientific notation |
| `int` | `42` | Integer value |
| `string` | `result` | Raw string |

## ğŸ”„ Compatibility Matrix

| Feature | Plain LaTeX | CSTeX |
|---------|-------------|--------|
| CSF Comments | âœ… Invisible | âœ… Processed |
| `\csfstatlink{name}{format}` | Shows format | Shows computed value + link |
| `\csftablelink{path}{step}` | Invisible | Shows provenance link |
| `\csfcomputelink{name}{format}` | Shows format | Shows computed value + link |
| Document Compilation | âœ… Works everywhere | âœ… Enhanced features |

## ğŸ¯ Key Benefits

1. **Zero Lock-in** - Documents work with any LaTeX distribution
2. **Gradual Adoption** - Mix automatic and declarative approaches
3. **Computational Transparency** - Live values from pipeline execution
4. **Professional Output** - Proper formatting with provenance links
5. **Error Prevention** - Values always fresh from source computation

## ğŸ” Troubleshooting

### PDF Generation Issues
```bash
# Check if composable.sty is found
nix run github:alexmill/texMini -- -interaction=nonstopmode test.tex

# Look for package loading errors in .log file
grep -i error test.log
```

### Missing Dependencies
```bash
# Install tomli for full value extraction (future feature)
pip install tomli

# Or use Nix shell for Python dependencies
nix shell nixpkgs#python3Packages.tomli
```

### Value Injection Not Working
```bash
# Check if .csf/values.tex exists
ls .csf/values.tex

# Verify values are defined
grep "csfdefinevalue" .csf/values.tex
```

## âœ… Success Criteria

Your implementation is working if:

1. âœ… `test_simple_declarative.pdf` generates successfully
2. âœ… CSF annotations are properly formatted in source
3. âœ… Fallback commands show format specifiers in plain LaTeX
4. âœ… Enhanced composable.sty loads without errors
5. âœ… All test scripts execute without major failures

## ğŸš€ Next Steps

1. **Use in Your Documents** - Start with simple CSF-STAT annotations
2. **Integrate with Pipeline** - Connect to your computational workflow  
3. **Explore Advanced Features** - Try CSF-COMPUTE expressions
4. **Test CSTeX Compilation** - When ready for full features

The CSF Declarative system is ready for production use! ğŸ‰